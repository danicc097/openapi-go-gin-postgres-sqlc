version: "3.8"

services:
  oidcserver:
    image: simple-oidc-server:latest
    container_name: simple-oidc-server
    build:
      context: ../external/oidc-server
      dockerfile: Dockerfile
    networks:
      - traefik-net
    ports:
      - 10001:10001
    command: ./server
    env_file:
      - ../.env.${APP_ENV:?not set}
    labels:
      - traefik.enable=true
      - traefik.http.routers.simple-oidc-server.rule=Host(`authserver.dev.localhost`) && PathPrefix("/oidc")
      - traefik.http.routers.simple-oidc-server.middlewares=strip_prefix_oidc # check docs to exclude requests from compression
      - traefik.http.middlewares.strip_prefix_oidc.stripprefix.prefixes=/oidc
      - traefik.docker.network=traefik-net
      - traefik.http.routers.simple-oidc-server.entrypoints=websecure
      - traefik.http.routers.simple-oidc-server.tls=true
      - traefik.http.services.simple-oidc-server.loadbalancer.server.port=10001
    restart: unless-stopped

networks:
  traefik-net:
    name: traefik-net
    external: true
